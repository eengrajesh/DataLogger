<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataLogger Dashboard - Raspberry Pi 5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--white);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--dark);
            font-size: 24px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .status-tile {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .status-tile.connected::before {
            background: var(--success);
        }

        .status-tile.disconnected::before {
            background: var(--danger);
        }

        .status-tile.warning::before {
            background: var(--warning);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .status-icon.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-icon.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .status-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .control-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light);
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .sensor-control {
            background: var(--light);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .sensor-config {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .toggle-slider {
            background: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .interval-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            background: var(--white);
        }

        .graph-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .graph-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .graph-controls {
            display: flex;
            gap: 10px;
        }

        .graph-control {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
        }

        .database-config {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .db-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .db-details {
            margin-top: 10px;
            padding: 10px;
            background: var(--white);
            border-radius: 6px;
            display: none;
        }

        .db-details.active {
            display: block;
        }

        .db-field {
            margin-bottom: 8px;
        }

        .db-field label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .db-field input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .export-section {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .date-field {
            display: flex;
            flex-direction: column;
        }

        .date-field label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .date-field input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .export-csv {
            background: #059669;
            color: white;
        }

        .export-json {
            background: #3b82f6;
            color: white;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1><i class="fas fa-temperature-high"></i> DataLogger Dashboard - RPi 5</h1>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="connectBoard()">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <button class="btn btn-danger" onclick="disconnectBoard()">
                    <i class="fas fa-power-off"></i> Disconnect
                </button>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-tile" id="board-status">
                <div class="status-header">
                    <span class="status-title">SMTC Board</span>
                    <div class="status-icon disconnected">
                        <i class="fas fa-microchip"></i>
                    </div>
                </div>
                <div class="status-value" id="board-status-text">Disconnected</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Address:</span>
                        <span id="board-address">0x16</span>
                    </div>
                    <div class="status-detail">
                        <span>Channels:</span>
                        <span id="board-channels">8</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="database-status">
                <div class="status-header">
                    <span class="status-title">Database</span>
                    <div class="status-icon connected">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="status-value" id="db-type">SQLite</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Records:</span>
                        <span id="db-records">0</span>
                    </div>
                    <div class="status-detail">
                        <span>Size:</span>
                        <span id="db-size">0 MB</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="storage-status">
                <div class="status-header">
                    <span class="status-title">Storage</span>
                    <div class="status-icon connected">
                        <i class="fas fa-hdd"></i>
                    </div>
                </div>
                <div class="status-value" id="storage-type">Local</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Free:</span>
                        <span id="storage-free">-- GB</span>
                    </div>
                    <div class="status-detail">
                        <span>Used:</span>
                        <span id="storage-percent">--%</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="logging-status">
                <div class="status-header">
                    <span class="status-title">Logging</span>
                    <div class="status-icon disconnected">
                        <i class="fas fa-circle"></i>
                    </div>
                </div>
                <div class="status-value" id="logging-state">Stopped</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Active Channels:</span>
                        <span id="active-channels">0/8</span>
                    </div>
                    <div class="status-detail">
                        <span>Rate:</span>
                        <span id="logging-rate">-- /min</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Channel Configuration</h3>
                    <div class="sensor-grid" id="sensor-controls">
                        <!-- Dynamically generated -->
                    </div>
                </div>

                <div class="control-section">
                    <h3>Logging Control</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" style="flex: 1" onclick="startLogging()">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="btn btn-danger" style="flex: 1" onclick="stopLogging()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Database Configuration</h3>
                    <div class="database-config">
                        <div class="db-option">
                            <input type="radio" id="db-sqlite" name="database" value="sqlite" checked onchange="switchDatabase('sqlite')">
                            <label for="db-sqlite">SQLite (Local)</label>
                        </div>
                        <div class="db-option">
                            <input type="radio" id="db-postgres" name="database" value="postgresql" onchange="switchDatabase('postgresql')">
                            <label for="db-postgres">PostgreSQL</label>
                        </div>
                        <div class="db-details" id="postgres-config">
                            <div class="db-field">
                                <label>Host</label>
                                <input type="text" id="pg-host" value="localhost">
                            </div>
                            <div class="db-field">
                                <label>Port</label>
                                <input type="number" id="pg-port" value="5432">
                            </div>
                            <div class="db-field">
                                <label>Database</label>
                                <input type="text" id="pg-database" value="datalogger">
                            </div>
                            <div class="db-field">
                                <label>Username</label>
                                <input type="text" id="pg-username">
                            </div>
                            <div class="db-field">
                                <label>Password</label>
                                <input type="password" id="pg-password">
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="connectPostgres()">
                                Connect to PostgreSQL
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Data Export</h3>
                    <div class="export-section">
                        <div class="date-range">
                            <div class="date-field">
                                <label>Start Date</label>
                                <input type="datetime-local" id="export-start">
                            </div>
                            <div class="date-field">
                                <label>End Date</label>
                                <input type="datetime-local" id="export-end">
                            </div>
                        </div>
                        <div class="export-buttons">
                            <button class="export-btn export-csv" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button class="export-btn export-json" onclick="exportData('json')">
                                <i class="fas fa-file-code"></i> JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="graph-container">
                <div class="graph-header">
                    <span class="graph-title">Live Temperature Data</span>
                    <div class="graph-controls">
                        <select class="graph-control" id="time-range" onchange="updateTimeRange()">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                        <button class="graph-control" onclick="toggleGraphType()">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
                <div id="temperature-graph" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        // Initialize sensor controls
        function initializeSensorControls() {
            const container = document.getElementById('sensor-controls');
            container.innerHTML = '';
            
            for (let i = 1; i <= 8; i++) {
                const control = document.createElement('div');
                control.className = 'sensor-control';
                control.innerHTML = `
                    <span class="sensor-label">CH ${i}</span>
                    <div class="sensor-config">
                        <select class="interval-select" id="interval-${i}" onchange="updateInterval(${i})">
                            <option value="1">1s</option>
                            <option value="5" selected>5s</option>
                            <option value="10">10s</option>
                            <option value="15">15s</option>
                            <option value="30">30s</option>
                            <option value="60">1m</option>
                            <option value="300">5m</option>
                            <option value="900">15m</option>
                        </select>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sensor-${i}" checked onchange="toggleSensor(${i})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                container.appendChild(control);
            }
        }

        // Initialize Plotly graph
        function initializeGraph() {
            const data = [{
                x: [],
                y: [],
                type: 'scatter',
                mode: 'lines',
                name: 'Channel 1'
            }];

            const layout = {
                title: '',
                xaxis: {
                    title: 'Time',
                    type: 'date'
                },
                yaxis: {
                    title: 'Temperature (Â°C)'
                },
                margin: { t: 30, r: 30, b: 50, l: 50 },
                showlegend: true,
                legend: {
                    x: 0,
                    y: 1,
                    bgcolor: 'rgba(255, 255, 255, 0.5)'
                }
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };

            Plotly.newPlot('temperature-graph', data, layout, config);
        }

        // API Functions
        async function connectBoard() {
            try {
                const response = await fetch('/api/connect', { method: 'POST' });
                const data = await response.json();
                updateBoardStatus(data.connected);
            } catch (error) {
                console.error('Error connecting to board:', error);
            }
        }

        async function disconnectBoard() {
            try {
                const response = await fetch('/api/disconnect', { method: 'POST' });
                const data = await response.json();
                updateBoardStatus(!data.disconnected);
            } catch (error) {
                console.error('Error disconnecting board:', error);
            }
        }

        async function startLogging() {
            try {
                const response = await fetch('/api/logging/start', { method: 'POST' });
                const data = await response.json();
                updateLoggingStatus(data.status === 'started');
            } catch (error) {
                console.error('Error starting logging:', error);
            }
        }

        async function stopLogging() {
            try {
                const response = await fetch('/api/logging/stop', { method: 'POST' });
                const data = await response.json();
                updateLoggingStatus(false);
            } catch (error) {
                console.error('Error stopping logging:', error);
            }
        }

        async function toggleSensor(channel) {
            const isActive = document.getElementById(`sensor-${channel}`).checked;
            try {
                const response = await fetch(`/api/sensor_status/${channel}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ active: isActive })
                });
                updateActiveChannelCount();
            } catch (error) {
                console.error('Error toggling sensor:', error);
            }
        }

        async function updateInterval(channel) {
            const interval = document.getElementById(`interval-${channel}`).value;
            try {
                const response = await fetch(`/api/sensor_interval/${channel}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: parseInt(interval) })
                });
            } catch (error) {
                console.error('Error updating interval:', error);
            }
        }

        function switchDatabase(type) {
            const postgresConfig = document.getElementById('postgres-config');
            if (type === 'postgresql') {
                postgresConfig.classList.add('active');
            } else {
                postgresConfig.classList.remove('active');
            }
        }

        async function connectPostgres() {
            const config = {
                host: document.getElementById('pg-host').value,
                port: document.getElementById('pg-port').value,
                database: document.getElementById('pg-database').value,
                username: document.getElementById('pg-username').value,
                password: document.getElementById('pg-password').value
            };
            
            try {
                const response = await fetch('/api/database/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'postgresql', config })
                });
                const data = await response.json();
                if (data.success) {
                    updateDatabaseStatus('PostgreSQL', data.info);
                }
            } catch (error) {
                console.error('Error connecting to PostgreSQL:', error);
            }
        }

        async function exportData(format) {
            const startDate = document.getElementById('export-start').value;
            const endDate = document.getElementById('export-end').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start', startDate);
            if (endDate) params.append('end', endDate);
            
            window.location.href = `/api/data/export/${format}?${params.toString()}`;
        }

        // Status Update Functions
        function updateBoardStatus(connected) {
            const tile = document.getElementById('board-status');
            const icon = tile.querySelector('.status-icon');
            const status = document.getElementById('board-status-text');
            
            if (connected) {
                tile.className = 'status-tile connected';
                icon.className = 'status-icon connected';
                status.textContent = 'Connected';
            } else {
                tile.className = 'status-tile disconnected';
                icon.className = 'status-icon disconnected';
                status.textContent = 'Disconnected';
            }
        }

        function updateLoggingStatus(active) {
            const tile = document.getElementById('logging-status');
            const icon = tile.querySelector('.status-icon');
            const status = document.getElementById('logging-state');
            
            if (active) {
                tile.className = 'status-tile connected';
                icon.className = 'status-icon connected';
                status.textContent = 'Active';
            } else {
                tile.className = 'status-tile disconnected';
                icon.className = 'status-icon disconnected';
                status.textContent = 'Stopped';
            }
        }

        function updateDatabaseStatus(type, info) {
            document.getElementById('db-type').textContent = type;
            if (info) {
                document.getElementById('db-records').textContent = info.record_count || 0;
                document.getElementById('db-size').textContent = `${info.size_mb || 0} MB`;
            }
        }

        function updateActiveChannelCount() {
            let active = 0;
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById(`sensor-${i}`).checked) {
                    active++;
                }
            }
            document.getElementById('active-channels').textContent = `${active}/8`;
        }

        // Real-time data update
        async function updateLiveData() {
            try {
                const response = await fetch('/api/data/latest');
                const data = await response.json();
                
                // Update graph with new data
                const traces = [];
                for (const reading of data) {
                    traces.push({
                        x: [reading.timestamp],
                        y: [reading.temperature],
                        name: `Channel ${reading.thermocouple_id}`,
                        mode: 'lines+markers'
                    });
                }
                
                if (traces.length > 0) {
                    Plotly.addTraces('temperature-graph', traces);
                }
                
            } catch (error) {
                console.error('Error fetching live data:', error);
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSensorControls();
            initializeGraph();
            
            // Set default date range for export
            const now = new Date();
            const yesterday = new Date(now - 24 * 60 * 60 * 1000);
            document.getElementById('export-end').value = now.toISOString().slice(0, 16);
            document.getElementById('export-start').value = yesterday.toISOString().slice(0, 16);
            
            // Start periodic updates
            setInterval(updateLiveData, 5000);
            
            // Update status tiles
            updateActiveChannelCount();
        });
    </script>
</body>
</html>