<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enertherm Engineering - Temperature Data Logger</title>
    <meta name="description" content="Professional Temperature Data Logging System by Enertherm Engineering">
    <meta name="author" content="Enertherm Engineering">
    <link rel="icon" type="image/png" href="/static/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --brand-gradient: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--white);
            border-radius: 12px;
            padding: 15px 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--brand-gradient);
        }

        .header-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-container {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.2);
            position: relative;
            overflow: hidden;
            padding: 5px;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .logo-fallback {
            color: var(--primary);
            font-size: 24px;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .company-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-dark);
            letter-spacing: -0.5px;
        }

        .product-name {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .critical-status {
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 15px;
        }
        
        .secondary-status {
            grid-template-columns: repeat(2, 1fr);
            max-width: 66%;
        }
        
        .temp-warning {
            margin-top: 10px;
            padding: 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 6px;
            color: var(--danger);
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .status-tile.temperature-warning::before {
            background: var(--warning);
            animation: warningBlink 1s infinite;
        }
        
        .status-tile.temperature-critical::before {
            background: var(--danger);
            animation: criticalBlink 0.5s infinite;
        }
        
        @keyframes warningBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes criticalBlink {
            0%, 100% { background: var(--danger); }
            50% { background: #dc2626; }
        }
        
        .status-tile {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-tile::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .status-tile.connected::before {
            background: var(--success);
        }

        .status-tile.disconnected::before {
            background: var(--danger);
        }

        .status-tile.warning::before {
            background: var(--warning);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .status-icon.connected {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-icon.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .status-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .status-detail {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            justify-content: space-between;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        .control-panel {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--light);
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .sensor-control {
            background: var(--light);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sensor-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--dark);
        }

        .sensor-config {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #cbd5e1;
            border-radius: 24px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .toggle-slider {
            background: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .interval-select {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            background: var(--white);
        }

        .graph-container {
            background: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .graph-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .graph-controls {
            display: flex;
            gap: 10px;
        }

        .graph-control {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
        }

        .database-config {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .db-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .db-details {
            margin-top: 10px;
            padding: 10px;
            background: var(--white);
            border-radius: 6px;
            display: none;
        }

        .db-details.active {
            display: block;
        }

        .db-field {
            margin-bottom: 8px;
        }

        .db-field label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .db-field input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .export-section {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .date-field {
            display: flex;
            flex-direction: column;
        }

        .date-field label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .date-field input {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .export-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .export-csv {
            background: #059669;
            color: white;
        }

        .export-json {
            background: #3b82f6;
            color: white;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <div class="header-brand">
                <div class="logo-container" id="logoContainer">
                    <i class="fas fa-temperature-high logo-fallback"></i>
                </div>
                <div class="brand-text">
                    <div class="company-name">ENERTHERM ENGINEERING</div>
                    <div class="product-name">Temperature Data Logger System</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="connectBoard()">
                    <i class="fas fa-plug"></i> Connect
                </button>
                <button class="btn btn-danger" onclick="disconnectBoard()">
                    <i class="fas fa-power-off"></i> Disconnect
                </button>
            </div>
        </div>

        <!-- System Status Row (Critical Items) -->
        <div class="status-grid critical-status">
            <div class="status-tile" id="board-status">
                <div class="status-header">
                    <span class="status-title">SMTC Board</span>
                    <div class="status-icon disconnected">
                        <i class="fas fa-microchip"></i>
                    </div>
                </div>
                <div class="status-value" id="board-status-text">Disconnected</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Address:</span>
                        <span id="board-address">0x16</span>
                    </div>
                    <div class="status-detail">
                        <span>Channels:</span>
                        <span id="board-channels">8</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="cpu-temp-status">
                <div class="status-header">
                    <span class="status-title">Board Temperature</span>
                    <div class="status-icon connected">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                </div>
                <div class="status-value" id="cpu-temp-value">--°C</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Status:</span>
                        <span id="cpu-temp-status-text">Normal</span>
                    </div>
                    <div class="status-detail">
                        <span>Threshold:</span>
                        <span id="cpu-temp-threshold">70°C</span>
                    </div>
                </div>
                <div class="temp-warning" id="temp-warning" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>High Temperature Warning!</span>
                </div>
            </div>

            <div class="status-tile" id="logging-status">
                <div class="status-header">
                    <span class="status-title">Logging</span>
                    <div class="status-icon disconnected">
                        <i class="fas fa-circle"></i>
                    </div>
                </div>
                <div class="status-value" id="logging-state">Stopped</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Active Channels:</span>
                        <span id="active-channels">0/8</span>
                    </div>
                    <div class="status-detail">
                        <span>Rate:</span>
                        <span id="logging-rate">-- /min</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage and Database Row (Secondary Items) -->
        <div class="status-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="status-tile" id="storage-status">
                <div class="status-header">
                    <span class="status-title">Storage</span>
                    <div class="status-icon connected">
                        <i class="fas fa-hdd"></i>
                    </div>
                </div>
                <div class="status-value" id="storage-type">Text Files + DB</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Text Files:</span>
                        <span id="textfile-count">-- files</span>
                    </div>
                    <div class="status-detail">
                        <span>Data Size:</span>
                        <span id="textfile-size">-- MB</span>
                    </div>
                    <div class="status-detail">
                        <span>Disk Free:</span>
                        <span id="storage-free">-- GB</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="database-status">
                <div class="status-header">
                    <span class="status-title">Database</span>
                    <div class="status-icon connected">
                        <i class="fas fa-database"></i>
                    </div>
                </div>
                <div class="status-value" id="db-type">SQLite</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Records:</span>
                        <span id="db-records">0</span>
                    </div>
                    <div class="status-detail">
                        <span>Size:</span>
                        <span id="db-size">0 MB</span>
                    </div>
                </div>
            </div>

            <div class="status-tile" id="network-status">
                <div class="status-header">
                    <span class="status-title">Network & Connectivity</span>
                    <div class="status-icon connected" id="network-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                </div>
                <div class="status-value" id="network-state">Connected</div>
                <div class="status-details">
                    <div class="status-detail">
                        <span>Local IP:</span>
                        <span id="local-ip">--</span>
                    </div>
                    <div class="status-detail">
                        <span>Telegram:</span>
                        <span id="telegram-status">Inactive</span>
                    </div>
                    <div class="status-detail">
                        <span>Uptime:</span>
                        <span id="system-uptime">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="control-section">
                    <h3>Channel Configuration</h3>
                    <div class="sensor-grid" id="sensor-controls">
                        <!-- Dynamically generated -->
                    </div>
                </div>

                <div class="control-section">
                    <h3>Logging Control</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success" style="flex: 1" onclick="startLogging()">
                            <i class="fas fa-play"></i> Start
                        </button>
                        <button class="btn btn-danger" style="flex: 1" onclick="stopLogging()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Database Configuration</h3>
                    <div class="database-config">
                        <div class="db-option">
                            <input type="radio" id="db-sqlite" name="database" value="sqlite" checked onchange="switchDatabase('sqlite')">
                            <label for="db-sqlite">SQLite Only (Local)</label>
                        </div>
                        <div class="db-option">
                            <input type="radio" id="db-postgres" name="database" value="postgresql" onchange="switchDatabase('postgresql')">
                            <label for="db-postgres">PostgreSQL Only</label>
                        </div>
                        <div class="db-option">
                            <input type="radio" id="db-both" name="database" value="both" onchange="switchDatabase('both')">
                            <label for="db-both">Both (SQLite + PostgreSQL) - Recommended</label>
                        </div>
                        <div class="db-details" id="postgres-config">
                            <div class="db-field">
                                <label>Host</label>
                                <input type="text" id="pg-host" value="localhost">
                            </div>
                            <div class="db-field">
                                <label>Port</label>
                                <input type="number" id="pg-port" value="5432">
                            </div>
                            <div class="db-field">
                                <label>Database</label>
                                <input type="text" id="pg-database" value="datalogger">
                            </div>
                            <div class="db-field">
                                <label>Username</label>
                                <input type="text" id="pg-username">
                            </div>
                            <div class="db-field">
                                <label>Password</label>
                                <input type="password" id="pg-password">
                            </div>
                            <button class="btn btn-primary" style="width: 100%; margin-top: 10px;" onclick="connectDatabase()">
                                Apply Configuration
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Email Notifications</h3>
                    <div class="export-section">
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 14px;">
                                <input type="checkbox" id="notifications-enabled">
                                Enable email notifications
                            </label>
                        </div>
                        
                        <div id="notification-config" style="display: none;">
                            <div class="db-field">
                                <label>SMTP Server</label>
                                <input type="text" id="smtp-server" value="smtp.gmail.com" style="width: 100%;">
                            </div>
                            <div class="db-field">
                                <label>Email Address</label>
                                <input type="email" id="smtp-username" placeholder="your.email@gmail.com" style="width: 100%;">
                            </div>
                            <div class="db-field">
                                <label>App Password</label>
                                <input type="password" id="smtp-password" placeholder="App-specific password" style="width: 100%;">
                            </div>
                            <div class="db-field">
                                <label>Alert Recipients (comma-separated)</label>
                                <input type="text" id="alert-recipients" placeholder="admin@company.com, tech@company.com" style="width: 100%;">
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary" style="flex: 1;" onclick="saveNotificationConfig()">
                                    <i class="fas fa-save"></i> Save Config
                                </button>
                                <button class="btn btn-success" style="flex: 1;" onclick="testNotifications()">
                                    <i class="fas fa-paper-plane"></i> Test Email
                                </button>
                            </div>
                        </div>
                        
                        <div id="notification-status" style="margin-top: 15px; padding: 10px; background: #f3f4f6; border-radius: 6px; font-size: 12px;">
                            <div><strong>Status:</strong> <span id="notif-status">Not configured</span></div>
                            <div><strong>Last Alert:</strong> <span id="notif-last-alert">None</span></div>
                            <div><strong>Connectivity:</strong> <span id="notif-connectivity">Unknown</span></div>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>Data Export</h3>
                    <div class="export-section">
                        <div class="export-source">
                            <label style="font-size: 12px; color: #6b7280; margin-bottom: 8px; display: block;">Export Source:</label>
                            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 14px;">
                                    <input type="radio" name="export-source" value="textfiles" checked>
                                    Text Files (Fast)
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 14px;">
                                    <input type="radio" name="export-source" value="database">
                                    Database
                                </label>
                            </div>
                        </div>

                        <div class="date-range">
                            <div class="date-field">
                                <label>Start Date</label>
                                <input type="datetime-local" id="export-start">
                            </div>
                            <div class="date-field">
                                <label>End Date</label>
                                <input type="datetime-local" id="export-end">
                            </div>
                        </div>

                        <div class="channel-filter" style="margin-bottom: 15px;">
                            <label style="font-size: 12px; color: #6b7280; margin-bottom: 8px; display: block;">Channels (optional):</label>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="1"> CH1
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="2"> CH2
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="3"> CH3
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="4"> CH4
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="5"> CH5
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="6"> CH6
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="7"> CH7
                                </label>
                                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px;">
                                    <input type="checkbox" name="export-channels" value="8"> CH8
                                </label>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 6px; font-size: 12px;">
                                <input type="checkbox" id="include-raw-temps">
                                Include raw temperature values
                            </label>
                        </div>

                        <div class="export-buttons">
                            <button class="export-btn export-csv" onclick="exportDataEnhanced('csv')">
                                <i class="fas fa-file-csv"></i> CSV Export
                            </button>
                            <button class="export-btn export-json" onclick="exportData('json')">
                                <i class="fas fa-file-code"></i> JSON
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3><i class="fas fa-folder-open" style="margin-right: 8px; color: var(--primary);"></i>Storage Information</h3>
                    <div class="export-section" id="storage-info-section">
                        <div style="font-size: 12px; color: #6b7280; margin-bottom: 15px;">
                            <i class="fas fa-info-circle"></i> Where your data is saved:
                        </div>

                        <!-- Database Storage -->
                        <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-database" style="color: #0ea5e9;"></i>
                                <span style="font-weight: 600; color: #0369a1;">SQLite Database (Primary)</span>
                            </div>
                            <div style="font-size: 11px; color: #374151; margin-left: 24px;">
                                <div style="margin-bottom: 4px;"><strong>File:</strong> <code id="storage-db-path" style="background: #e0f2fe; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Loading...</code></div>
                                <div style="margin-bottom: 4px;"><strong>Size:</strong> <span id="storage-db-size">--</span> MB</div>
                                <div><strong>Records:</strong> <span id="storage-db-records">--</span></div>
                            </div>
                        </div>

                        <!-- Text File Storage -->
                        <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-file-alt" style="color: #22c55e;"></i>
                                <span style="font-weight: 600; color: #15803d;">Text Files (Backup)</span>
                            </div>
                            <div style="font-size: 11px; color: #374151; margin-left: 24px;">
                                <div style="margin-bottom: 6px;">
                                    <strong>Raw Files:</strong> <code id="storage-raw-path" style="background: #dcfce7; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Loading...</code>
                                    <span style="color: #6b7280; margin-left: 4px;">(<span id="storage-raw-count">--</span> files)</span>
                                </div>
                                <div>
                                    <strong>Daily Files:</strong> <code id="storage-daily-path" style="background: #dcfce7; padding: 2px 6px; border-radius: 3px; font-size: 10px;">Loading...</code>
                                    <span style="color: #6b7280; margin-left: 4px;">(<span id="storage-daily-count">--</span> files)</span>
                                </div>
                            </div>
                        </div>

                        <!-- How Data is Saved -->
                        <div style="background: #fefce8; border: 1px solid #eab308; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <i class="fas fa-cogs" style="color: #ca8a04;"></i>
                                <span style="font-weight: 600; color: #854d0e;">How Data is Saved</span>
                            </div>
                            <div style="font-size: 11px; color: #374151; margin-left: 24px;">
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: #fef9c3; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600;">1</span>
                                    <span id="storage-step1">Temperature read from sensor</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: #fef9c3; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600;">2</span>
                                    <span id="storage-step2">Calibration correction applied</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: #fef9c3; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600;">3</span>
                                    <span id="storage-step3">Saved to SQLite database</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span style="background: #fef9c3; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600;">4</span>
                                    <span id="storage-step4">Saved to text file backup</span>
                                </div>
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #eab308; color: #854d0e;">
                                    <i class="fas fa-clock"></i> <strong>Interval:</strong> <span id="storage-interval">Every 5 seconds per channel</span>
                                </div>
                            </div>
                        </div>

                        <!-- Refresh Button -->
                        <button class="btn btn-primary" style="width: 100%; margin-top: 12px;" onclick="loadStorageInfo()">
                            <i class="fas fa-sync-alt"></i> Refresh Storage Info
                        </button>
                    </div>
                </div>
            </div>

            <div class="graph-container">
                <div class="graph-header">
                    <span class="graph-title">Live Temperature Data</span>
                    <div class="graph-controls">
                        <select class="graph-control" id="time-range" onchange="updateTimeRange()">
                            <option value="1">Last 1 Hour</option>
                            <option value="6">Last 6 Hours</option>
                            <option value="24" selected>Last 24 Hours</option>
                            <option value="168">Last Week</option>
                        </select>
                        <button class="graph-control" onclick="toggleGraphType()">
                            <i class="fas fa-chart-line"></i>
                        </button>
                    </div>
                </div>
                <div id="temperature-graph" style="height: 400px;"></div>
                
                <!-- Channel Averages Display -->
                <div style="margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                        Channel Statistics (Current Session)
                    </h4>
                    <div id="channel-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Channel names storage
        let channelNames = {};

        // Fetch channel names from API
        async function fetchChannelNames() {
            try {
                const response = await fetch('/api/channels');
                if (response.ok) {
                    channelNames = await response.json();
                    console.log('[DEBUG] Channel names loaded:', channelNames);
                }
            } catch (error) {
                console.error('Error fetching channel names:', error);
            }
        }

        // Get channel display name
        function getChannelName(channel) {
            if (channelNames[channel] && channelNames[channel].name) {
                return channelNames[channel].name;
            }
            return `CH${channel}`;
        }

        // Initialize sensor controls
        async function initializeSensorControls() {
            // Fetch channel names first
            await fetchChannelNames();

            const container = document.getElementById('sensor-controls');
            container.innerHTML = '';

            for (let i = 1; i <= 8; i++) {
                const control = document.createElement('div');
                control.className = 'sensor-control';
                const name = getChannelName(i);
                control.innerHTML = `
                    <span class="sensor-label" id="channel-name-${i}" title="CH${i}: ${name}">${name}</span>
                    <div class="sensor-config">
                        <select class="interval-select" id="interval-${i}" onchange="updateInterval(${i})">
                            <option value="1">1s</option>
                            <option value="5" selected>5s</option>
                            <option value="10">10s</option>
                            <option value="15">15s</option>
                            <option value="30">30s</option>
                            <option value="60">1m</option>
                            <option value="300">5m</option>
                            <option value="900">15m</option>
                        </select>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sensor-${i}" checked onchange="toggleSensor(${i})">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                `;
                container.appendChild(control);
            }
        }

        // Initialize Plotly graph - starts empty until data is available
        function initializeGraph() {
            const layout = {
                title: {
                    text: 'Temperature Trends',
                    font: { size: 16 }
                },
                xaxis: {
                    title: 'Time',
                    type: 'date',
                    gridcolor: '#E5E7EB',
                    showgrid: true
                },
                yaxis: {
                    title: 'Temperature (°C)',
                    gridcolor: '#E5E7EB',
                    showgrid: true,
                    range: [0, 100]
                },
                margin: { t: 50, r: 150, b: 50, l: 60 },
                annotations: [{
                    text: 'No data available<br>Connect board and start logging',
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.5,
                    y: 0.5,
                    xanchor: 'center',
                    yanchor: 'middle',
                    showarrow: false,
                    font: { size: 16, color: '#9CA3AF' }
                }],
                plot_bgcolor: '#FAFAFA',
                paper_bgcolor: '#FFFFFF'
            };

            const config = {
                responsive: true,
                displayModeBar: false  // Hide toolbar until data is available
            };

            Plotly.newPlot('temperature-graph', [], layout, config);
        }

        // Check system status on page load
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                console.log('[DEBUG] Page loaded - System status:', data);

                // Update board connection status
                if (data.board_info && data.board_info.board_info) {
                    updateBoardStatus(data.board_info.board_info.connected);
                } else {
                    updateBoardStatus(false);
                }

                // Update logging status
                updateLoggingStatus(data.logging_active);

            } catch (error) {
                console.error('Error checking system status:', error);
            }
        }

        // API Functions
        async function connectBoard() {
            try {
                const response = await fetch('/api/connect', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success' && data.board_info) {
                    updateBoardStatus(data.board_info.connected);
                }
            } catch (error) {
                console.error('Error connecting to board:', error);
            }
        }

        async function disconnectBoard() {
            try {
                const response = await fetch('/api/disconnect', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success' && data.board_info) {
                    updateBoardStatus(data.board_info.connected);
                }
            } catch (error) {
                console.error('Error disconnecting board:', error);
            }
        }

        async function startLogging() {
            try {
                const response = await fetch('/api/logging/start', { method: 'POST' });
                const data = await response.json();
                updateLoggingStatus(data.status === 'success');
            } catch (error) {
                console.error('Error starting logging:', error);
            }
        }

        async function stopLogging() {
            try {
                const response = await fetch('/api/logging/stop', { method: 'POST' });
                const data = await response.json();
                updateLoggingStatus(false);
            } catch (error) {
                console.error('Error stopping logging:', error);
            }
        }

        async function toggleSensor(channel) {
            const isActive = document.getElementById(`sensor-${channel}`).checked;
            try {
                const response = await fetch(`/api/sensor_status/${channel}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: isActive })
                });
                updateActiveChannelCount();
            } catch (error) {
                console.error('Error toggling sensor:', error);
            }
        }

        async function updateInterval(channel) {
            const interval = document.getElementById(`interval-${channel}`).value;
            try {
                const response = await fetch(`/api/sensor_interval/${channel}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: parseInt(interval) })
                });
            } catch (error) {
                console.error('Error updating interval:', error);
            }
        }

        function switchDatabase(type) {
            const postgresConfig = document.getElementById('postgres-config');
            if (type === 'postgresql' || type === 'both') {
                postgresConfig.classList.add('active');
            } else {
                postgresConfig.classList.remove('active');
            }
        }

        async function connectDatabase() {
            // Get selected database type
            const dbType = document.querySelector('input[name="database"]:checked').value;

            const config = {
                host: document.getElementById('pg-host').value,
                port: document.getElementById('pg-port').value,
                database: document.getElementById('pg-database').value,
                username: document.getElementById('pg-username').value,
                password: document.getElementById('pg-password').value
            };

            try {
                const response = await fetch('/api/database/switch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: dbType, config })
                });
                const data = await response.json();

                if (data.success) {
                    if (dbType === 'both') {
                        alert('Successfully configured dual database mode!\nData will be saved to both SQLite and PostgreSQL.');
                        updateDatabaseStatus('Dual (SQLite + PostgreSQL)', data.info);
                    } else if (dbType === 'postgresql') {
                        alert('Successfully connected to PostgreSQL database!');
                        updateDatabaseStatus('PostgreSQL', data.info);
                    } else {
                        alert('Switched to SQLite database.');
                        updateDatabaseStatus('SQLite', data.info);
                    }

                    // Refresh database status
                    setTimeout(() => {
                        updateDatabaseInfo();
                    }, 500);
                } else {
                    alert(`Database connection failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error connecting to database:', error);
                alert(`Database connection error: ${error.message}`);
            }
        }

        // Backward compatibility
        async function connectPostgres() {
            await connectDatabase();
        }

        async function exportData(format) {
            const startDate = document.getElementById('export-start').value;
            const endDate = document.getElementById('export-end').value;
            
            const params = new URLSearchParams();
            if (startDate) params.append('start', startDate);
            if (endDate) params.append('end', endDate);
            
            window.location.href = `/api/data/export/${format}?${params.toString()}`;
        }

        // Enhanced export function with text file support
        async function exportDataEnhanced(format) {
            const startDate = document.getElementById('export-start').value;
            const endDate = document.getElementById('export-end').value;
            const exportSource = document.querySelector('input[name="export-source"]:checked').value;
            const includeRaw = document.getElementById('include-raw-temps').checked;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            // Get selected channels
            const channelCheckboxes = document.querySelectorAll('input[name="export-channels"]:checked');
            const selectedChannels = Array.from(channelCheckboxes).map(cb => parseInt(cb.value));
            
            if (exportSource === 'textfiles') {
                // Export from text files
                try {
                    const response = await fetch('/api/textfiles/export_csv', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate,
                            channels: selectedChannels.length > 0 ? selectedChannels : null,
                            include_raw: includeRaw
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `temperature_data_${startDate.replace(/[:\-T]/g, '')}_${endDate.replace(/[:\-T]/g, '')}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    } else {
                        const error = await response.json();
                        alert(`Export failed: ${error.error}`);
                    }
                } catch (error) {
                    alert(`Export failed: ${error.message}`);
                }
            } else {
                // Export from database (existing method)
                exportData(format);
            }
        }

        // Update text file storage statistics
        async function updateTextFileStats() {
            try {
                const response = await fetch('/api/textfiles/stats');
                if (response.ok) {
                    const stats = await response.json();

                    const totalFiles = stats.raw_files + stats.daily_files + stats.compressed_files;
                    document.getElementById('textfile-count').textContent = `${totalFiles} files`;
                    document.getElementById('textfile-size').textContent = `${stats.total_size_mb} MB`;

                    // Update tooltip or additional info if needed
                    const storageStatus = document.getElementById('storage-status');
                    storageStatus.title = `Raw: ${stats.raw_files}, Daily: ${stats.daily_files}, Compressed: ${stats.compressed_files}`;
                } else {
                    console.error('Failed to fetch text file stats');
                }
            } catch (error) {
                console.error('Error fetching text file stats:', error);
            }
        }

        // Load storage information for the Storage Info panel
        async function loadStorageInfo() {
            try {
                const response = await fetch('/api/storage_info');
                if (response.ok) {
                    const info = await response.json();

                    // Update database info
                    if (info.database) {
                        // Show just the filename for cleaner display
                        const dbPath = info.database.path;
                        const dbFilename = dbPath.split(/[/\\]/).pop();
                        document.getElementById('storage-db-path').textContent = dbFilename;
                        document.getElementById('storage-db-path').title = dbPath; // Full path on hover
                        document.getElementById('storage-db-size').textContent = info.database.size_mb || '0';
                        document.getElementById('storage-db-records').textContent = info.database.record_count?.toLocaleString() || '0';
                    }

                    // Update text files info
                    if (info.text_files) {
                        // Show shortened paths
                        const rawPath = info.text_files.raw_path;
                        const dailyPath = info.text_files.daily_path;

                        // Extract last 2 folder segments for display
                        const rawShort = rawPath.split(/[/\\]/).slice(-2).join('/');
                        const dailyShort = dailyPath.split(/[/\\]/).slice(-2).join('/');

                        document.getElementById('storage-raw-path').textContent = rawShort;
                        document.getElementById('storage-raw-path').title = rawPath;
                        document.getElementById('storage-raw-count').textContent = info.text_files.raw_file_count || '0';

                        document.getElementById('storage-daily-path').textContent = dailyShort;
                        document.getElementById('storage-daily-path').title = dailyPath;
                        document.getElementById('storage-daily-count').textContent = info.text_files.daily_file_count || '0';
                    }

                    // Update how data is saved steps
                    if (info.how_data_is_saved) {
                        document.getElementById('storage-step1').textContent = info.how_data_is_saved.step1 || 'Temperature read from sensor';
                        document.getElementById('storage-step2').textContent = info.how_data_is_saved.step2 || 'Calibration correction applied';
                        document.getElementById('storage-step3').textContent = info.how_data_is_saved.step3 || 'Saved to SQLite database';
                        document.getElementById('storage-step4').textContent = info.how_data_is_saved.step4 || 'Saved to text file backup';
                        document.getElementById('storage-interval').textContent = info.how_data_is_saved.interval || 'Every 5 seconds per channel';
                    }

                    console.log('[Storage] Storage info loaded successfully');
                } else {
                    console.error('Failed to fetch storage info');
                }
            } catch (error) {
                console.error('Error fetching storage info:', error);
                // Set error state
                document.getElementById('storage-db-path').textContent = 'Error loading';
                document.getElementById('storage-raw-path').textContent = 'Error loading';
                document.getElementById('storage-daily-path').textContent = 'Error loading';
            }
        }

        // ============= Notification System Functions =============
        
        // Toggle notification configuration visibility
        document.getElementById('notifications-enabled')?.addEventListener('change', function() {
            const configDiv = document.getElementById('notification-config');
            if (this.checked) {
                configDiv.style.display = 'block';
                loadNotificationConfig();
            } else {
                configDiv.style.display = 'none';
            }
        });

        // Load notification configuration
        async function loadNotificationConfig() {
            try {
                const response = await fetch('/api/notifications/config');
                if (response.ok) {
                    const config = await response.json();
                    
                    document.getElementById('notifications-enabled').checked = config.enabled;
                    document.getElementById('smtp-server').value = config.smtp?.server || 'smtp.gmail.com';
                    document.getElementById('smtp-username').value = config.smtp?.username || '';
                    document.getElementById('smtp-password').value = config.smtp?.password || '';
                    
                    // Load recipients
                    const allRecipients = [
                        ...(config.recipients?.critical || []),
                        ...(config.recipients?.warning || []),
                        ...(config.recipients?.info || [])
                    ];
                    document.getElementById('alert-recipients').value = [...new Set(allRecipients)].join(', ');
                    
                    if (config.enabled) {
                        document.getElementById('notification-config').style.display = 'block';
                    }
                } else {
                    console.error('Failed to load notification config');
                }
            } catch (error) {
                console.error('Error loading notification config:', error);
            }
        }

        // Save notification configuration
        async function saveNotificationConfig() {
            try {
                const enabled = document.getElementById('notifications-enabled').checked;
                const server = document.getElementById('smtp-server').value;
                const username = document.getElementById('smtp-username').value;
                const password = document.getElementById('smtp-password').value;
                const recipientsText = document.getElementById('alert-recipients').value;
                
                const recipients = recipientsText.split(',').map(email => email.trim()).filter(email => email);
                
                const config = {
                    enabled: enabled,
                    smtp: {
                        server: server,
                        port: 587,
                        use_tls: true,
                        username: username,
                        password: password
                    },
                    recipients: {
                        critical: recipients,
                        warning: recipients,
                        info: recipients,
                        reports: recipients
                    },
                    alerts: {
                        cpu_temperature: true,
                        board_disconnect: true,
                        internet_disconnect: true,
                        logging_stopped: true,
                        disk_space: true,
                        power_events: true
                    }
                };
                
                const response = await fetch('/api/notifications/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    alert('Notification configuration saved successfully!');
                    updateNotificationStatus();
                } else {
                    const error = await response.json();
                    alert(`Failed to save configuration: ${error.error}`);
                }
            } catch (error) {
                alert(`Error saving configuration: ${error.message}`);
            }
        }

        // Test notifications
        async function testNotifications() {
            try {
                const response = await fetch('/api/notifications/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Test email sent successfully! Check your inbox.');
                } else {
                    alert(`Test email failed: ${result.message}`);
                }
            } catch (error) {
                alert(`Test email error: ${error.message}`);
            }
        }

        // Update notification status
        async function updateNotificationStatus() {
            try {
                const response = await fetch('/api/notifications/status');
                if (response.ok) {
                    const status = await response.json();
                    
                    document.getElementById('notif-status').textContent = status.enabled 
                        ? (status.running ? 'Running' : 'Configured but stopped') 
                        : 'Disabled';
                    
                    document.getElementById('notif-connectivity').textContent = 
                        `Internet: ${status.connectivity?.internet?.connected ? 'Connected' : 'Disconnected'}, ` +
                        `Board: ${status.connectivity?.board?.connected ? 'Connected' : 'Disconnected'}`;
                    
                    if (status.sent_alerts_count > 0) {
                        document.getElementById('notif-last-alert').textContent = `${status.sent_alerts_count} alerts sent`;
                    }
                } else {
                    console.error('Failed to fetch notification status');
                }
            } catch (error) {
                console.error('Error fetching notification status:', error);
            }
        }

        // Status Update Functions
        function updateBoardStatus(connected) {
            const tile = document.getElementById('board-status');
            const icon = tile.querySelector('.status-icon');
            const status = document.getElementById('board-status-text');
            
            if (connected) {
                tile.className = 'status-tile connected';
                icon.className = 'status-icon connected';
                status.textContent = 'Connected';
            } else {
                tile.className = 'status-tile disconnected';
                icon.className = 'status-icon disconnected';
                status.textContent = 'Disconnected';
            }
        }

        function updateLoggingStatus(active) {
            const tile = document.getElementById('logging-status');
            const icon = tile.querySelector('.status-icon');
            const status = document.getElementById('logging-state');
            
            if (active) {
                tile.className = 'status-tile connected';
                icon.className = 'status-icon connected';
                status.textContent = 'Active';
            } else {
                tile.className = 'status-tile disconnected';
                icon.className = 'status-icon disconnected';
                status.textContent = 'Stopped';
            }
        }

        function updateDatabaseStatus(type, info) {
            document.getElementById('db-type').textContent = type;
            if (info) {
                document.getElementById('db-records').textContent = info.record_count || 0;
                document.getElementById('db-size').textContent = `${info.size_mb || 0} MB`;
            }
        }

        function updateActiveChannelCount() {
            let active = 0;
            for (let i = 1; i <= 8; i++) {
                if (document.getElementById(`sensor-${i}`).checked) {
                    active++;
                }
            }
            document.getElementById('active-channels').textContent = `${active}/8`;
        }

        // Network status monitoring
        let systemStartTime = Date.now();

        async function updateNetworkStatus() {
            try {
                const response = await fetch('/api/network_status');
                const data = await response.json();

                if (response.ok) {
                    const networkTile = document.getElementById('network-status');
                    const networkIcon = document.getElementById('network-icon');
                    const networkState = document.getElementById('network-state');

                    // Update internet connectivity
                    const isConnected = data.internet_connected;
                    if (isConnected) {
                        networkTile.className = 'status-tile connected';
                        networkIcon.className = 'status-icon connected';
                        networkState.textContent = 'Online';
                    } else {
                        networkTile.className = 'status-tile disconnected';
                        networkIcon.className = 'status-icon disconnected';
                        networkState.textContent = 'Offline';
                    }

                    // Update local IP
                    document.getElementById('local-ip').textContent = data.local_ip || 'Unknown';

                    // Update Telegram status
                    const telegramStatus = data.telegram_active ? 'Active' : 'Inactive';
                    const telegramEl = document.getElementById('telegram-status');
                    telegramEl.textContent = telegramStatus;
                    telegramEl.style.color = data.telegram_active ? 'var(--success)' : '#9ca3af';
                    telegramEl.style.fontWeight = data.telegram_active ? '600' : '500';

                    // Update uptime
                    if (data.uptime_seconds) {
                        const uptime = formatUptime(data.uptime_seconds);
                        document.getElementById('system-uptime').textContent = uptime;
                    } else {
                        // Calculate from page load (fallback)
                        const uptimeSeconds = Math.floor((Date.now() - systemStartTime) / 1000);
                        document.getElementById('system-uptime').textContent = formatUptime(uptimeSeconds);
                    }
                }

            } catch (error) {
                console.error('Error fetching network status:', error);
                document.getElementById('network-state').textContent = 'Unknown';
            }
        }

        function formatUptime(seconds) {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);

            if (days > 0) {
                return `${days}d ${hours}h`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }

        // CPU Temperature monitoring
        async function updateCpuTemperature() {
            try {
                const response = await fetch('/api/cpu_temperature');
                const data = await response.json();
                
                if (response.ok) {
                    const temp = data.temperature;
                    const status = data.status;
                    const tempValue = document.getElementById('cpu-temp-value');
                    const tempStatus = document.getElementById('cpu-temp-status-text');
                    const tempTile = document.getElementById('cpu-temp-status');
                    const tempIcon = tempTile.querySelector('.status-icon');
                    const tempWarning = document.getElementById('temp-warning');
                    
                    if (temp > 0) {
                        tempValue.textContent = `${temp.toFixed(1)}°C`;
                        
                        // Reset classes
                        tempTile.className = 'status-tile';
                        tempIcon.className = 'status-icon';
                        
                        switch (status) {
                            case 'critical':
                                tempTile.className = 'status-tile temperature-critical';
                                tempIcon.className = 'status-icon disconnected';
                                tempStatus.textContent = 'CRITICAL';
                                tempStatus.style.color = 'var(--danger)';
                                tempStatus.style.fontWeight = '600';
                                tempWarning.style.display = 'flex';
                                tempWarning.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>CRITICAL: Board overheating! Take action immediately!</span>';
                                tempWarning.style.background = 'rgba(239, 68, 68, 0.2)';
                                break;
                                
                            case 'warning':
                                tempTile.className = 'status-tile temperature-warning';
                                tempIcon.className = 'status-icon connected';
                                tempIcon.style.background = 'rgba(245, 158, 11, 0.1)';
                                tempIcon.style.color = 'var(--warning)';
                                tempStatus.textContent = 'WARNING';
                                tempStatus.style.color = 'var(--warning)';
                                tempStatus.style.fontWeight = '600';
                                tempWarning.style.display = 'flex';
                                tempWarning.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Board temperature is high - monitor closely</span>';
                                tempWarning.style.background = 'rgba(245, 158, 11, 0.1)';
                                tempWarning.style.borderColor = 'var(--warning)';
                                tempWarning.style.color = 'var(--warning)';
                                break;
                                
                            default: // normal
                                tempTile.className = 'status-tile connected';
                                tempIcon.className = 'status-icon connected';
                                tempStatus.textContent = 'Normal';
                                tempStatus.style.color = 'var(--success)';
                                tempStatus.style.fontWeight = '500';
                                tempWarning.style.display = 'none';
                                break;
                        }
                        
                        document.getElementById('cpu-temp-threshold').textContent = `${data.warning_threshold}°C`;
                    } else {
                        tempValue.textContent = 'N/A';
                        tempStatus.textContent = 'Unavailable';
                        tempStatus.style.color = '#9ca3af';
                        tempIcon.className = 'status-icon disconnected';
                        tempWarning.style.display = 'none';
                    }
                    
                } else {
                    console.error('Failed to fetch CPU temperature:', data.error);
                }
                
            } catch (error) {
                console.error('Error fetching CPU temperature:', error);
                document.getElementById('cpu-temp-value').textContent = 'Error';
                document.getElementById('cpu-temp-status-text').textContent = 'Error';
            }
        }

        // Store data for averaging
        let channelData = {};
        for (let i = 1; i <= 8; i++) {
            channelData[i] = [];
        }

        // Calculate and display channel statistics
        function updateChannelStats() {
            const statsContainer = document.getElementById('channel-stats');
            statsContainer.innerHTML = '';

            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
                '#98D8C8', '#FFD93D', '#6C5CE7', '#A8E6CF'
            ];

            let hasAnyData = false;

            for (let channel = 1; channel <= 8; channel++) {
                const data = channelData[channel];

                // Check if sensor checkbox is enabled
                const sensorCheckbox = document.getElementById(`sensor-${channel}`);
                const isSensorEnabled = sensorCheckbox ? sensorCheckbox.checked : true;

                // Only show stats if channel has data AND sensor is enabled
                if (data && data.length > 0 && isSensorEnabled) {
                    hasAnyData = true;
                    const avg = (data.reduce((a, b) => a + b, 0) / data.length).toFixed(2);
                    const min = Math.min(...data).toFixed(2);
                    const max = Math.max(...data).toFixed(2);
                    const latest = data[data.length - 1].toFixed(2);
                    const chName = getChannelName(channel);

                    const statDiv = document.createElement('div');
                    statDiv.style.cssText = `
                        background: white;
                        padding: 12px;
                        border-radius: 8px;
                        border-left: 4px solid ${colors[channel-1]};
                        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
                    `;
                    statDiv.innerHTML = `
                        <div style="font-size: 12px; font-weight: 600; color: ${colors[channel-1]}; margin-bottom: 8px;" title="CH${channel}">
                            ${chName}
                        </div>
                        <div style="background: linear-gradient(135deg, ${colors[channel-1]}15, ${colors[channel-1]}05); padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                            <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px;">Average</div>
                            <div style="font-size: 20px; font-weight: 700; color: ${colors[channel-1]}; line-height: 1;">${avg}°C</div>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; line-height: 1.6;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Current:</span>
                                <span style="font-weight: 600; color: #111827;">${latest}°C</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Range:</span>
                                <span style="font-weight: 600; color: #111827;">${min}°C - ${max}°C</span>
                            </div>
                        </div>
                    `;
                    statsContainer.appendChild(statDiv);
                }
            }

            // Show placeholder if no data available
            if (!hasAnyData) {
                showPlaceholderStats();
            }
        }

        // Real-time data update with proper line continuity
        async function updateLiveData() {
            try {
                // Get the selected time range from dropdown (default to 24 hours)
                const timeRangeSelect = document.getElementById('time-range');
                const hours = timeRangeSelect ? timeRangeSelect.value : 24;

                // Fetch historical data for the selected time range
                const response = await fetch(`/api/data/historical?hours=${hours}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    // Group data by channel for graphing
                    const channelGroups = {};
                    data.forEach(reading => {
                        const ch = reading.thermocouple_id;
                        if (!channelGroups[ch]) {
                            channelGroups[ch] = { x: [], y: [] };
                        }
                        channelGroups[ch].x.push(reading.timestamp);
                        channelGroups[ch].y.push(reading.temperature);

                        // Store for statistics (keep recent data only)
                        if (!channelData[ch]) channelData[ch] = [];
                        channelData[ch].push(reading.temperature);

                        // Keep only last 100 readings for performance
                        if (channelData[ch].length > 100) {
                            channelData[ch] = channelData[ch].slice(-100);
                        }
                    });

                    updateGraph(channelGroups);
                }

                // Always try to update statistics with latest data
                await updateChannelStatsFromLatest();

            } catch (error) {
                console.error('Error fetching live data:', error);
                // Even if historical data fails, try to get latest readings
                await updateChannelStatsFromLatest();
            }
        }

        // Update graph with channel data
        function updateGraph(channelGroups) {
            const traces = [];
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
                '#98D8C8', '#FFD93D', '#6C5CE7', '#A8E6CF'
            ];

            // Check if we have any actual data
            let hasData = false;
            Object.keys(channelGroups).forEach(channel => {
                const chData = channelGroups[channel];

                // Check if sensor checkbox is enabled
                const sensorCheckbox = document.getElementById(`sensor-${channel}`);
                const isSensorEnabled = sensorCheckbox ? sensorCheckbox.checked : true;

                // Only show data if channel has data AND sensor is enabled
                if (chData.x && chData.x.length > 0 && isSensorEnabled) {
                    hasData = true;
                    const chName = getChannelName(channel);
                    traces.push({
                        x: chData.x,
                        y: chData.y,
                        type: 'scatter',
                        mode: 'lines',
                        name: chName,
                        line: {
                            color: colors[parseInt(channel) - 1],
                            width: 2,
                            shape: 'spline'
                        },
                        connectgaps: true
                    });
                }
            });

            if (hasData) {
                // Chart with data - auto-scale y-axis based on actual readings
                Plotly.newPlot('temperature-graph', traces, {
                    title: { text: 'Temperature Trends', font: { size: 16 } },
                    xaxis: { title: 'Time', type: 'date', gridcolor: '#E5E7EB', showgrid: true },
                    yaxis: { title: 'Temperature (°C)', gridcolor: '#E5E7EB', showgrid: true, autorange: true },
                    margin: { t: 50, r: 150, b: 50, l: 60 },
                    showlegend: true,
                    legend: {
                        orientation: 'v', x: 1.02, y: 1, xanchor: 'left',
                        bgcolor: 'rgba(255, 255, 255, 0.9)', bordercolor: '#E5E7EB',
                        borderwidth: 1, font: { size: 11 }
                    },
                    hovermode: 'x unified',
                    plot_bgcolor: '#FAFAFA',
                    paper_bgcolor: '#FFFFFF'
                }, {
                    responsive: true, displayModeBar: true, displaylogo: false,
                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                });
            } else {
                // No data - show empty chart with message
                Plotly.newPlot('temperature-graph', [], {
                    title: { text: 'Temperature Trends', font: { size: 16 } },
                    xaxis: { title: 'Time', type: 'date', gridcolor: '#E5E7EB', showgrid: true },
                    yaxis: { title: 'Temperature (°C)', gridcolor: '#E5E7EB', showgrid: true, range: [0, 100] },
                    margin: { t: 50, r: 150, b: 50, l: 60 },
                    annotations: [{
                        text: 'No data available<br>Connect board and start logging',
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.5,
                        y: 0.5,
                        xanchor: 'center',
                        yanchor: 'middle',
                        showarrow: false,
                        font: { size: 16, color: '#9CA3AF' }
                    }],
                    plot_bgcolor: '#FAFAFA',
                    paper_bgcolor: '#FFFFFF'
                }, {
                    responsive: true, displayModeBar: false
                });
            }
        }

        // Update channel statistics from latest readings
        async function updateChannelStatsFromLatest() {
            try {
                const response = await fetch('/api/data/latest');
                if (response.ok) {
                    const latestData = await response.json();
                    
                    if (latestData && latestData.length > 0) {
                        // Update channelData with latest readings
                        latestData.forEach(reading => {
                            const ch = reading.thermocouple_id;
                            if (!channelData[ch]) channelData[ch] = [];
                            
                            // Add latest reading if it's new
                            channelData[ch].push(reading.temperature);
                            
                            // Keep only recent data
                            if (channelData[ch].length > 50) {
                                channelData[ch] = channelData[ch].slice(-50);
                            }
                        });
                        
                        // Update statistics display
                        updateChannelStats();
                    }
                }
            } catch (error) {
                console.error('Error fetching latest data for stats:', error);
                // Show placeholder if no data available
                showPlaceholderStats();
            }
        }

        // Show placeholder when no data is available
        function showPlaceholderStats() {
            const statsContainer = document.getElementById('channel-stats');
            if (statsContainer.children.length === 0) {
                statsContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #9ca3af; font-size: 14px;">
                        <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                        No temperature data available yet. 
                        <br><br>
                        <strong>To see statistics:</strong><br>
                        1. Connect to SMTC Board<br>
                        2. Start Logging<br>
                        3. Wait for data collection
                    </div>
                `;
            }
        }

        // Force update statistics (for testing)
        function forceUpdateStats() {
            updateChannelStatsFromLatest();
        }

        // Generate demo data for testing (when no real data available)
        function generateDemoStats() {
            console.log('Generating demo statistics...');
            
            // Clear existing data
            for (let i = 1; i <= 8; i++) {
                channelData[i] = [];
            }
            
            // Generate sample data for channels 1-4 (simulate active channels)
            for (let ch = 1; ch <= 4; ch++) {
                const baseTemp = 20 + (ch * 5); // Different base temps per channel
                for (let i = 0; i < 20; i++) {
                    const temp = baseTemp + (Math.random() - 0.5) * 4; // ±2°C variation
                    channelData[ch].push(temp);
                }
            }
            
            updateChannelStats();
        }

        // Function to update time range
        async function updateTimeRange() {
            // Clear stored data for statistics
            for (let i = 1; i <= 8; i++) {
                channelData[i] = [];
            }

            // Reload data with new time range
            await updateLiveData();
        }

        // Function to load logo
        function loadLogo() {
            const logoContainer = document.getElementById('logoContainer');

            // Try to load modern SVG logo first (better quality)
            const svgImg = new Image();
            svgImg.onload = function() {
                logoContainer.innerHTML = '';
                logoContainer.appendChild(svgImg);
            };

            svgImg.onerror = function() {
                // Fallback to PNG
                const img = new Image();
                img.onload = function() {
                    logoContainer.innerHTML = '';
                    logoContainer.appendChild(img);
                };

                img.onerror = function() {
                    // Keep the fallback icon - change background back to gradient
                    logoContainer.style.background = 'var(--brand-gradient)';
                    console.log('Logo files not found, using fallback icon');
                };

                img.src = '/static/logo.png';
            };

            // Try modern logo first, then minimal, then original SVG
            svgImg.src = '/static/logo-modern.svg';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSensorControls();
            initializeGraph();
            showPlaceholderStats();  // Show placeholder until data arrives
            loadLogo();  // Load logo

            // Set default date range for export
            const now = new Date();
            const yesterday = new Date(now - 24 * 60 * 60 * 1000);
            document.getElementById('export-end').value = now.toISOString().slice(0, 16);
            document.getElementById('export-start').value = yesterday.toISOString().slice(0, 16);

            // Start periodic updates
            setInterval(updateLiveData, 5000);
            setInterval(updateCpuTemperature, 3000);  // Update CPU temp every 3 seconds
            setInterval(updateTextFileStats, 30000);  // Update text file stats every 30 seconds
            setInterval(updateNotificationStatus, 15000);  // Update notification status every 15 seconds
            setInterval(updateNetworkStatus, 10000);  // Update network status every 10 seconds

            // Check current system status on page load
            checkSystemStatus();

            // Update status tiles
            updateActiveChannelCount();
            updateCpuTemperature();  // Initial CPU temp check
            updateTextFileStats();   // Initial text file stats
            loadNotificationConfig(); // Load notification configuration
            updateNotificationStatus(); // Initial notification status
            updateNetworkStatus();  // Initial network status
            loadStorageInfo();  // Load storage information panel
            
            // Initial data load
            setTimeout(() => {
                updateLiveData(); // Try to load data after page is ready
                
                // If still no data after 3 seconds, show placeholder
                setTimeout(() => {
                    showPlaceholderStats();
                }, 3000);
            }, 1000);
        });
    </script>

    <!-- Footer -->
    <div style="background: white; border-top: 1px solid #e5e7eb; padding: 20px; margin-top: 30px; text-align: center;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div style="text-align: left; flex: 1; min-width: 200px;">
                    <div style="font-weight: 600; color: var(--primary); font-size: 14px; margin-bottom: 5px;">
                        Enertherm Engineering
                    </div>
                    <div style="font-size: 12px; color: #6b7280;">
                        Temperature Data Logger System
                    </div>
                    <div style="font-size: 11px; color: #9ca3af; margin-top: 3px;">
                        Professional Temperature Monitoring Solutions
                    </div>
                </div>

                <div style="text-align: center; flex: 1; min-width: 200px;">
                    <div style="font-size: 13px; color: #374151; margin-bottom: 5px;">
                        <strong>Version 2.0.0</strong>
                    </div>
                    <div style="font-size: 11px; color: #6b7280;">
                        Build Date: October 2025
                    </div>
                </div>

                <div style="text-align: right; flex: 1; min-width: 200px;">
                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">
                        &copy; 2025 Enertherm Engineering
                    </div>
                    <div style="font-size: 11px; color: #9ca3af;">
                        All Rights Reserved
                    </div>
                    <div style="font-size: 10px; color: #9ca3af; margin-top: 3px;">
                        Licensed for Commercial Use
                    </div>
                </div>
            </div>

            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f3f4f6;">
                <div style="font-size: 10px; color: #9ca3af; line-height: 1.5;">
                    This software is proprietary and confidential. Unauthorized copying, distribution, or modification is strictly prohibited.
                </div>
            </div>
        </div>
    </div>
</body>
</html>